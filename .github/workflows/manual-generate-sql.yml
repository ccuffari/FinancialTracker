# .github/workflows/generate-db-structure.yml
name: Generate Database Structure

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch da utilizzare'
        required: true
        default: 'main'
        type: string
      python_version:
        description: 'Versione Python'
        required: true
        default: '3.10'
        type: choice
        options:
          - '3.8'
          - '3.9'
          - '3.10'
          - '3.11'
          - '3.12'
      deploy_to_neon:
        description: 'Deploy su PostgreSQL Neon'
        required: true
        default: false
        type: boolean

env:
  PYTHON_VERSION: ${{ github.event.inputs.python_version }}
  BRANCH_NAME: ${{ github.event.inputs.branch }}
  DEPLOY_ENABLED: ${{ github.event.inputs.deploy_to_neon }}

jobs:
  # =====================================
  # JOB 1: GENERAZIONE DDL
  # =====================================
  generate-ddl:
    name: ðŸ“ Generate Database DDL
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    outputs:
      ddl-generated: ${{ steps.generate.outputs.success }}
      file-path: ${{ steps.generate.outputs.file-path }}
      file-size: ${{ steps.generate.outputs.file-size }}
      tables-count: ${{ steps.generate.outputs.tables-count }}
      schemas-count: ${{ steps.generate.outputs.schemas-count }}
    
    steps:
    - name: ðŸš€ Workflow Started
      run: |
        echo "::notice title=Workflow Started::Generazione struttura database iniziata"
        echo "ðŸ“‹ Parametri ricevuti:"
        echo "   ðŸŒ¿ Branch: ${{ env.BRANCH_NAME }}"
        echo "   ðŸ Python: ${{ env.PYTHON_VERSION }}"
        echo "   ðŸš€ Deploy: ${{ env.DEPLOY_ENABLED }}"
        echo "   ðŸ‘¤ Triggered by: ${{ github.actor }}"
        echo "   ðŸ• Started at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
    
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        ref: ${{ env.BRANCH_NAME }}
        token: ${{ secrets.GITHUB_TOKEN }}
      
    - name: âœ… Repository Checked Out
      run: |
        echo "::notice title=Checkout Success::Repository checked out successfully"
        echo "ðŸ“ Current directory: $(pwd)"
        echo "ðŸ“Š Repository info:"
        echo "   ðŸ“ Commit: $(git rev-parse --short HEAD)"
        echo "   ðŸ‘¤ Author: $(git log -1 --pretty=format:'%an')"
        echo "   ðŸ“… Date: $(git log -1 --pretty=format:'%ad')"
        echo "   ðŸ’¬ Message: $(git log -1 --pretty=format:'%s')"
    
    - name: ðŸ Setup Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: âœ… Python Setup Complete
      run: |
        echo "::notice title=Python Ready::Python ${{ env.PYTHON_VERSION }} configured successfully"
        echo "ðŸ Python version: $(python --version)"
        echo "ðŸ“¦ Pip version: $(pip --version)"
        echo "ðŸ“ Python location: $(which python)"
    
    - name: ðŸ’¾ Cache Dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('models/python/db_structure_generator/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: ðŸ“¦ Install Dependencies
      run: |
        echo "::group::ðŸ“¦ Installing Python Dependencies"
        python -m pip install --upgrade pip
        
        echo "ðŸ“‹ Installing requirements..."
        pip install -r models/python/db_structure_generator/requirements.txt
        
        echo "ðŸ—„ï¸ Installing PostgreSQL client..."
        pip install psycopg2-binary
        
        echo "âœ… Dependencies installed successfully"
        echo "ðŸ“Š Installed packages:"
        pip list | head -20
        echo "::endgroup::"
    
    - name: ðŸ” Verify Prerequisites
      run: |
        echo "::group::ðŸ” Verifying Prerequisites"
        
        # Verifica file Excel
        if [ ! -f "data/financialTracker.xlsx" ]; then
          echo "::error title=Excel File Missing::File data/financialTracker.xlsx non trovato!"
          exit 1
        fi
        
        echo "âœ… File Excel trovato"
        echo "ðŸ“Š Excel file info:"
        echo "   ðŸ“ Path: data/financialTracker.xlsx"
        echo "   ðŸ“ Size: $(du -h data/financialTracker.xlsx | cut -f1)"
        echo "   ðŸ“… Modified: $(stat -c '%y' data/financialTracker.xlsx)"
        
        # Verifica struttura progetto
        echo "ðŸ“‚ Project structure verification:"
        for dir in "models/python/db_structure_generator" "data"; do
          if [ -d "$dir" ]; then
            echo "   âœ… $dir exists"
          else
            echo "::error title=Directory Missing::Directory $dir not found!"
            exit 1
          fi
        done
        
        echo "::endgroup::"
    
    - name: ðŸ“ Create Output Directory
      run: |
        mkdir -p sql/ddl
        echo "::notice title=Directory Created::Output directory sql/ddl created"
        echo "ðŸ“ Created directory: sql/ddl"
        echo "ðŸ”§ Permissions: $(ls -la sql/ddl)"
    
    - name: ðŸ”¨ Generate Database Structure
      id: generate
      run: |
        echo "::group::ðŸ”¨ Generating Database DDL"
        cd models/python/db_structure_generator
        
        echo "ðŸš€ Starting DDL generation..."
        if python main.py; then
          echo "::notice title=Generation Success::DDL generated successfully"
          echo "success=true" >> $GITHUB_OUTPUT
          
          # Torna alla root per verificare il file
          cd ../../..
          
          if [ -f "sql/ddl/financial_tracker_ddl.sql" ]; then
            file_size=$(du -h sql/ddl/financial_tracker_ddl.sql | cut -f1)
            line_count=$(wc -l < sql/ddl/financial_tracker_ddl.sql)
            char_count=$(wc -c < sql/ddl/financial_tracker_ddl.sql)
            
            echo "file-path=sql/ddl/financial_tracker_ddl.sql" >> $GITHUB_OUTPUT
            echo "file-size=$file_size" >> $GITHUB_OUTPUT
            
            echo "ðŸ“Š Generated file statistics:"
            echo "   ðŸ“ File: sql/ddl/financial_tracker_ddl.sql"
            echo "   ðŸ“ Size: $file_size"
            echo "   ðŸ“„ Lines: $line_count"
            echo "   ðŸ”¤ Characters: $char_count"
            
            # Estrai informazioni dal SQL generato
            schema_count=$(grep -c "CREATE SCHEMA" sql/ddl/financial_tracker_ddl.sql || echo "0")
            table_count=$(grep -c "CREATE TABLE" sql/ddl/financial_tracker_ddl.sql || echo "0")
            
            echo "schemas-count=$schema_count" >> $GITHUB_OUTPUT
            echo "tables-count=$table_count" >> $GITHUB_OUTPUT
            
            echo "ðŸ—ï¸ Database structure:"
            echo "   ðŸ“Š Schemas: $schema_count"
            echo "   ðŸ—‚ï¸ Tables: $table_count"
            
            echo "ðŸ“– First 10 lines of generated SQL:"
            head -10 sql/ddl/financial_tracker_ddl.sql
          else
            echo "::error title=File Missing::Generated SQL file not found!"
            echo "success=false" >> $GITHUB_OUTPUT
            exit 1
          fi
        else
          echo "::error title=Generation Failed::DDL generation failed"
          echo "success=false" >> $GITHUB_OUTPUT
          exit 1
        fi
        echo "::endgroup::"
    
    - name: ðŸ’¾ Upload SQL Artifact
      if: steps.generate.outputs.success == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: database-ddl-${{ env.BRANCH_NAME }}-py${{ env.PYTHON_VERSION }}
        path: sql/ddl/financial_tracker_ddl.sql
        retention-days: 30
    
    - name: âœ… Artifact Uploaded
      if: steps.generate.outputs.success == 'true'
      run: |
        echo "::notice title=Artifact Ready::SQL artifact uploaded successfully"
        echo "ðŸ’¾ Artifact name: database-ddl-${{ env.BRANCH_NAME }}-py${{ env.PYTHON_VERSION }}"
        echo "â° Retention: 30 days"
        echo "ðŸ“¥ Download available in Actions tab"
    
    - name: ðŸ“ Commit Generated SQL
      if: steps.generate.outputs.success == 'true' && (env.BRANCH_NAME == 'main' || env.BRANCH_NAME == 'develop')
      run: |
        echo "::group::ðŸ“ Committing Generated Files"
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        if [ -n "$(git status --porcelain sql/ddl/)" ]; then
          git add sql/ddl/financial_tracker_ddl.sql
          git commit -m "ðŸ¤– Auto-generated database DDL from financialTracker.xlsx
          
          - Branch: ${{ env.BRANCH_NAME }}
          - Python: ${{ env.PYTHON_VERSION }}
          - Schemas: ${{ steps.generate.outputs.schemas-count }}
          - Tables: ${{ steps.generate.outputs.tables-count }}
          - Size: ${{ steps.generate.outputs.file-size }}
          - Generated: $(date '+%Y-%m-%d %H:%M:%S UTC')"
          
          git push
          echo "::notice title=Commit Success::Generated SQL committed and pushed"
          echo "âœ… File committed and pushed successfully"
        else
          echo "::warning title=No Changes::No changes to commit"
          echo "â„¹ï¸ Generated SQL file is identical to existing version"
        fi
        echo "::endgroup::"

  # =====================================
  # JOB 2: DEPLOY SU NEON (Condizionale)
  # =====================================
  deploy-to-neon:
    name: ðŸš€ Deploy to Neon PostgreSQL
    runs-on: ubuntu-latest
    needs: generate-ddl
    if: github.event.inputs.deploy_to_neon == 'true' && needs.generate-ddl.outputs.ddl-generated == 'true'
    
    steps:
    - name: ðŸš€ Deploy Job Started
      run: |
        echo "::notice title=Deploy Started::Starting deployment to Neon PostgreSQL"
        echo "ðŸŽ¯ Target: PostgreSQL Neon"
        echo "ðŸ“ Branch: ${{ env.BRANCH_NAME }}"
        echo "ðŸ“Š Schemas to deploy: ${{ needs.generate-ddl.outputs.schemas-count }}"
        echo "ðŸ—‚ï¸ Tables to deploy: ${{ needs.generate-ddl.outputs.tables-count }}"
        echo "ðŸ“ File size: ${{ needs.generate-ddl.outputs.file-size }}"
    
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        ref: ${{ env.BRANCH_NAME }}
    
    - name: ðŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: ðŸ“¦ Install PostgreSQL Client
      run: |
        echo "::group::ðŸ“¦ Installing PostgreSQL Client"
        python -m pip install --upgrade pip
        pip install psycopg2-binary
        echo "âœ… PostgreSQL client installed"
        echo "::endgroup::"
    
    - name: ðŸ“¥ Download SQL Artifact
      uses: actions/download-artifact@v4
      with:
        name: database-ddl-${{ env.BRANCH_NAME }}-py${{ env.PYTHON_VERSION }}
        path: ./sql-download
    
    - name: âœ… Artifact Downloaded
      run: |
        echo "::notice title=Artifact Downloaded::SQL file downloaded successfully"
        if [ -f "./sql-download/financial_tracker_ddl.sql" ]; then
          echo "âœ… SQL file found in artifact"
          echo "ðŸ“ Size: $(du -h ./sql-download/financial_tracker_ddl.sql | cut -f1)"
          mkdir -p sql/ddl
          cp ./sql-download/financial_tracker_ddl.sql sql/ddl/
        else
          echo "::error title=File Missing::SQL file not found in artifact"
          exit 1
        fi
    
    - name: ðŸ”— Test Database Connection
      env:
        PGHOST: ${{ secrets.PGHOST }}
        PGDATABASE: ${{ secrets.PGDATABASE }}
        PGUSER: ${{ secrets.PGUSER }}
        PGPASSWORD: ${{ secrets.PGPASSWORD }}
        PGSSLMODE: ${{ secrets.PGSSLMODE }}
      run: |
        echo "::group::ðŸ”— Testing Database Connection"
        python -c "
        import psycopg2
        import os
        import sys
        
        try:
            print('ðŸ”— Attempting connection to Neon PostgreSQL...')
            conn = psycopg2.connect(
                host=os.environ['PGHOST'],
                database=os.environ['PGDATABASE'], 
                user=os.environ['PGUSER'],
                password=os.environ['PGPASSWORD'],
                sslmode=os.environ['PGSSLMODE'],
                connect_timeout=30
            )
            
            with conn.cursor() as cursor:
                cursor.execute('SELECT version();')
                version = cursor.fetchone()[0]
                print(f'âœ… Connection successful!')
                print(f'ðŸ“Š PostgreSQL version: {version}')
                
                cursor.execute('SELECT current_database(), current_user, inet_server_addr(), inet_server_port();')
                db_info = cursor.fetchone()
                print(f'ðŸ—„ï¸ Database: {db_info[0]}')
                print(f'ðŸ‘¤ User: {db_info[1]}')
                print(f'ðŸŒ Server: {db_info[2]}:{db_info[3]}')
            
            conn.close()
            
        except Exception as e:
            print(f'::error title=Connection Failed::Failed to connect to database: {str(e)}')
            sys.exit(1)
        "
        echo "::endgroup::"
    
    - name: ðŸ—„ï¸ Execute Database DDL
      env:
        PGHOST: ${{ secrets.PGHOST }}
        PGDATABASE: ${{ secrets.PGDATABASE }}
        PGUSER: ${{ secrets.PGUSER }}
        PGPASSWORD: ${{ secrets.PGPASSWORD }}
        PGSSLMODE: ${{ secrets.PGSSLMODE }}
      run: |
        echo "::group::ðŸ—„ï¸ Executing Database DDL"
        python -c "
        import psycopg2
        import os
        import sys
        import time
        
        try:
            print('ðŸ“– Reading SQL file...')
            with open('sql/ddl/financial_tracker_ddl.sql', 'r', encoding='utf-8') as f:
                sql_content = f.read()
            
            print(f'ðŸ“Š SQL file loaded: {len(sql_content)} characters')
            
            print('ðŸ”— Connecting to database...')
            conn = psycopg2.connect(
                host=os.environ['PGHOST'],
                database=os.environ['PGDATABASE'],
                user=os.environ['PGUSER'],
                password=os.environ['PGPASSWORD'],
                sslmode=os.environ['PGSSLMODE']
            )
            
            print('ðŸ”„ Executing DDL (this may take a moment)...')
            start_time = time.time()
            
            with conn.cursor() as cursor:
                cursor.execute(sql_content)
                conn.commit()
            
            execution_time = time.time() - start_time
            print(f'âœ… DDL executed successfully in {execution_time:.2f} seconds!')
            
            # Verifica risultati
            print('ðŸ” Verifying created objects...')
            with conn.cursor() as cursor:
                # Conta schemi
                cursor.execute('''
                    SELECT COUNT(*) FROM information_schema.schemata 
                    WHERE schema_name NOT IN ('information_schema', 'pg_catalog', 'pg_toast', 'public');
                ''')
                schema_count = cursor.fetchone()[0]
                
                # Conta tabelle
                cursor.execute('''
                    SELECT schemaname, tablename 
                    FROM pg_tables 
                    WHERE schemaname NOT IN ('information_schema', 'pg_catalog', 'pg_toast')
                    ORDER BY schemaname, tablename;
                ''')
                tables = cursor.fetchall()
                
                # Conta vincoli FK
                cursor.execute('''
                    SELECT COUNT(*) FROM information_schema.table_constraints 
                    WHERE constraint_type = 'FOREIGN KEY';
                ''')
                fk_count = cursor.fetchone()[0]
                
                print(f'ðŸ“Š Deployment results:')
                print(f'   ðŸ—ï¸ Schemas created: {schema_count}')
                print(f'   ðŸ—‚ï¸ Tables created: {len(tables)}')
                print(f'   ðŸ”— Foreign keys: {fk_count}')
                
                if tables:
                    print(f'ðŸ“‹ Created tables:')
                    for schema, table in tables:
                        print(f'   - {schema}.{table}')
            
            conn.close()
            print('ðŸŽ‰ Database deployment completed successfully!')
            
        except psycopg2.Error as e:
            print(f'::error title=Database Error::Database error during deployment: {str(e)}')
            sys.exit(1)
        except Exception as e:
            print(f'::error title=Deployment Failed::Unexpected error during deployment: {str(e)}')
            sys.exit(1)
        "
        echo "::endgroup::"
    
    - name: ðŸŽ‰ Deploy Complete
      run: |
        echo "::notice title=Deploy Success::Deployment to Neon PostgreSQL completed successfully"
        echo "ðŸŽ‰ Database deployment successful!"
        echo "ðŸŒ Host: ${{ secrets.PGHOST }}"
        echo "ðŸ—„ï¸ Database: ${{ secrets.PGDATABASE }}"
        echo "ðŸ‘¤ User: ${{ secrets.PGUSER }}"
        echo "ðŸ”’ SSL: Enabled"
        echo "â° Completed at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"

  # =====================================
  # JOB 3: SUMMARY FINALE
  # =====================================
  summary:
    name: ðŸ“‹ Workflow Summary
    runs-on: ubuntu-latest
    needs: [generate-ddl, deploy-to-neon]
    if: always()
    
    steps:
    - name: ðŸ“‹ Final Summary
      run: |
        echo "::notice title=Workflow Complete::Database structure generation workflow completed"
        echo "# ðŸŽ¯ Workflow Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“‹ Execution Details" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: ${{ env.BRANCH_NAME }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Python Version**: ${{ env.PYTHON_VERSION }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Triggered by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Timestamp**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## ðŸ“ DDL Generation" >> $GITHUB_STEP_SUMMARY
        if [ "${{ needs.generate-ddl.result }}" == "success" ]; then
          echo "- âœ… **Status**: Success" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“Š **Schemas**: ${{ needs.generate-ddl.outputs.schemas-count }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ—‚ï¸ **Tables**: ${{ needs.generate-ddl.outputs.tables-count }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“ **File Size**: ${{ needs.generate-ddl.outputs.file-size }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ’¾ **Artifact**: database-ddl-${{ env.BRANCH_NAME }}-py${{ env.PYTHON_VERSION }}" >> $GITHUB_STEP_SUMMARY
        else
          echo "- âŒ **Status**: Failed" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## ðŸš€ Neon Deployment" >> $GITHUB_STEP_SUMMARY
        if [ "${{ env.DEPLOY_ENABLED }}" == "true" ]; then
          if [ "${{ needs.deploy-to-neon.result }}" == "success" ]; then
            echo "- âœ… **Status**: Success" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸŽ¯ **Target**: PostgreSQL Neon" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ—„ï¸ **Database**: ${{ secrets.PGDATABASE }}" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.deploy-to-neon.result }}" == "failure" ]; then
            echo "- âŒ **Status**: Failed" >> $GITHUB_STEP_SUMMARY
          else
            echo "- â© **Status**: Skipped (DDL generation failed)" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "- â© **Status**: Disabled" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## ðŸŽ¯ Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "1. Download the generated DDL from the **Artifacts** section" >> $GITHUB_STEP_SUMMARY
        echo "2. Review the SQL structure before production deployment" >> $GITHUB_STEP_SUMMARY
        echo "3. Test the schema in a development environment" >> $GITHUB_STEP_SUMMARY
        echo "4. Update your application connection strings if needed" >> $GITHUB_STEP_SUMMARY
